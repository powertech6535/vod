name: Merge EPG for OTT App

on:
  schedule:
    - cron: "0 */6 * * *"  # 每 6 小时更新一次
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ 安装依赖
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet curl sed

      # 3️⃣ 下载所有 EPG 源，去掉第5、6、7个
      - name: Download All EPG Sources
        run: |
          mkdir -p epg_sources
          cd epg_sources

          declare -A urls
          urls[1]="https://raw.githubusercontent.com/AqFad2811/epg/main/epg.xml"
          urls[2]="https://raw.githubusercontent.com/AqFad2811/epg/main/unifitv.xml"
          urls[3]="https://raw.githubusercontent.com/AqFad2811/epg/main/astro.xml"
          urls[4]="https://raw.githubusercontent.com/azimabid00/epg/main/unifi_epg.xml"
          # 第5,6,7 URL 已删除
          urls[8]="https://raw.githubusercontent.com/azimabid00/epg/main/astro_epg.xml"
          urls[9]="https://raw.githubusercontent.com/AqFad2811/epg/main/indonesia.xml"

          for i in "${!urls[@]}"; do
            URL="${urls[$i]}"
            echo "Downloading $URL..."
            curl -fSL -o "$i.xml" "$URL" || echo "Warning: download failed for $URL, skipping."
            if [ ! -s "$i.xml" ]; then
              echo "Warning: $i.xml is empty, skipping."
              rm -f "$i.xml"
            fi
          done
          cd ..

      # 4️⃣ 清理 XML 文件并合并，修复截断标签
      - name: Clean and Merge EPG
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > epg.xml
          echo '<tv>' >> epg.xml

          # 删除 XML 声明, DOCTYPE, <tv> 标签
          for f in epg_sources/*.xml; do
            [ -s "$f" ] || continue
            sed -i '/<?xml/d' "$f"
            sed -i '/<!DOCTYPE/d' "$f"
            sed -i 's/<tv>//g' "$f"
            sed -i 's/<\/tv>//g' "$f"
          done

          # 合并 channels
          for f in epg_sources/*.xml; do
            [ -s "$f" ] || continue
            xmlstarlet sel -t -c "//channel" "$f" >> epg.xml
          done

          # 去重 channels
          xmlstarlet ed -d '//channel[not(@id=preceding-sibling::channel/@id)]' epg.xml > epg_tmp.xml
          mv epg_tmp.xml epg.xml

          # 合并 programmes
          for f in epg_sources/*.xml; do
            [ -s "$f" ] || continue
            xmlstarlet sel -t -c "//programme" "$f" >> epg.xml
          done

          # 去重 programmes：同频道同时间段只保留第一个
          xmlstarlet ed -d '//programme[generate-id() != generate-id(key(concat(@channel, "-", @start), concat(@channel, "-", @start))[1])]' epg.xml > epg_tmp.xml || true
          mv epg_tmp.xml epg.xml

          echo '</tv>' >> epg.xml

      # 5️⃣ 校验 XML 完整性
      - name: Validate XML
        run: |
          xmlstarlet val -e epg.xml

      # 6️⃣ 上传 Release
      - name: Upload EPG to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          files: epg.xml
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
