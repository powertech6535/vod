name: Merge EPG with Logo

on:
  schedule:
    - cron: "0 */6 * * *" # 每 6 小时更新一次
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 拉取仓库
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ 安装工具
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet curl sed

      # 3️⃣ 下载所有 EPG 源（加验证防止空文件）
      - name: Download All EPG Sources
        run: |
          mkdir epg_sources
          cd epg_sources

          for i in 1 2 3 4 5 6 7 8 9 10; do
            URL=""
            case $i in
              1) URL="https://raw.githubusercontent.com/AqFad2811/epg/main/epg.xml" ;;
              2) URL="https://raw.githubusercontent.com/AqFad2811/epg/main/unifitv.xml" ;;
              3) URL="https://raw.githubusercontent.com/AqFad2811/epg/main/astro.xml" ;;
              4) URL="https://raw.githubusercontent.com/azimabid00/epg/main/unifi_epg.xml" ;;
              5) URL="https://i.mjh.nz/PlutoTV/all.xml" ;;
              6) URL="https://i.mjh.nz/SamsungTVPlus/us.xml" ;;
              7) URL="https://i.mjh.nz/SamsungTVPlus/kr.xml" ;;
              8) URL="https://raw.githubusercontent.com/azimabid00/epg/main/astro_epg.xml" ;;
              9) URL="https://raw.githubusercontent.com/AqFad2811/epg/main/indonesia.xml" ;;
            esac

            curl -fSL -o "$i.xml" "$URL" || { echo "Download $URL failed"; exit 1; }
          done
          cd ..

      # 4️⃣ 合并频道和节目
      - name: Merge Channels and Programmes
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > epg.xml
          echo '<tv>' >> epg.xml

          # 清理源文件的 xml 声明和 DTD
          for f in epg_sources/*.xml; do
            sed -i '1,/<tv>/d' "$f"
            sed -i '/<\/tv>/d' "$f"
          done

          # 合并 channel（保留 tvg-id, tvg-name, tvg-logo）
          for f in epg_sources/*.xml; do
            xmlstarlet sel -t -c "//channel" "$f" >> epg.xml
          done

          # 去重 channel
          xmlstarlet ed -d '//channel[not(@id=preceding-sibling::channel/@id)]' epg.xml > epg_tmp.xml
          mv epg_tmp.xml epg.xml

          # 合并 programme
          for f in epg_sources/*.xml; do
            xmlstarlet sel -t -c "//programme" "$f" >> epg.xml
          done

          echo '</tv>' >> epg.xml

      # 5️⃣ 上传 Release，文件名固定 epg.xml
      - name: Upload EPG to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          files: epg.xml
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
